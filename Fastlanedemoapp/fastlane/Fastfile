default_platform(:ios)

platform :ios do
  desc "Set Xcode version from GitHub env"
  lane :setup_xcode_version do |options|
    xcodeVersion = options[:xcodeVersionGit]
    UI.message("ðŸ“¦ Setting Xcode version to: #{xcodeVersion}")
    sh("sudo xcode-select -s /Applications/#{xcodeVersion}")
    xcodebuild_path = `xcrun --find xcodebuild`.strip
    xcode_version_output = `xcodebuild -version`
    UI.message("âœ… xcode-select now points to: #{xcodebuild_path}")
    UI.message("ðŸ”§ xcodebuild -version output:\n#{xcode_version_output}")
  end

  desc "Run tests with scan"
  lane :test do
    # Find first available "iPhone 16 Pro" simulator (any OS version)
    device_name = `xcrun simctl list devices available | grep "iPhone 16 Pro" | head -n 1 | awk -F '[()]' '{print $1}'`.strip
    os_version = `xcrun simctl list devices available | grep "iPhone 16 Pro" | head -n 1 | grep -o "(.*)" | tr -d '()'`.strip
    full_device = "#{device_name}(#{os_version})"

    UI.message("ðŸ›  Using simulator: #{full_device}")

    scan(
      scheme: "Testapp", # Must match your scheme name exactly
      device: full_device,
      clean: true,
      code_coverage: true
    )
  end
end
