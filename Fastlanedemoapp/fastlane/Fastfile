default_platform(:ios)

platform :ios do

  before_all do
    # Clean derived data, Pods, Podfile.lock
    sh "rm -rf ~/Library/Developer/Xcode/DerivedData/* Pods Podfile.lock"
  end

  lane :beta do

    # 1️⃣ Select Xcode dynamically based on runner OS
    if ENV['AGENT_SPEC'] == 'macos-14'
      xcode_select("/Applications/Xcode_16.2.app") # adjust version as needed
    elsif ENV['AGENT_SPEC'] == 'macos-15'
      xcode_select("/Applications/Xcode_16.4.app")
    else
      xcode_select("/Applications/Xcode.app")
    end

    # 2️⃣ Install Pods with post_install Swift version override for macOS-15
    cocoapods(
      clean_install: true,
      verbose: true,
      podfile: "./Podfile"
    )

    # Ensure Pods project uses Swift 5.9 if macOS-15 (Swift 6 strict)
    if ENV['AGENT_SPEC'] == 'macos-15'
      require 'cocoapods'
      post_install do |installer|
        installer.pods_project.targets.each do |target|
          target.build_configurations.each do |config|
            config.build_settings['SWIFT_VERSION'] = '5.9'
          end
        end
      end
    end

    # 3️⃣ Increment build & version numbers
    increment_build_number
    increment_version_number(version_number: "1.0") # adjust as needed

    # 4️⃣ Build & archive
    build_app(
      workspace: "./Fastlanedemoapp.xcworkspace",
      scheme: "Fastlanedemoapp",
      clean: true,
      export_method: "app-store",
      include_symbols: true,
      include_bitcode: true
    )

  end

end
