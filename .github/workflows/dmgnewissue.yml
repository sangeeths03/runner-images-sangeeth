name: Repro macOS Finder AppleEvent Timeout

on:
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-14

    steps:
      - name: Show macOS version
        run: sw_vers

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create dummy .app bundle
        run: |
          mkdir -p release/darwin/mac-arm64/MyApp.app/Contents/MacOS
          echo -e '#!/bin/bash\necho Hello World' > release/darwin/mac-arm64/MyApp.app/Contents/MacOS/MyApp
          chmod +x release/darwin/mac-arm64/MyApp.app/Contents/MacOS/MyApp

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create solid gray background PNG
        run: |
          mkdir -p resources
          cat > resources/background.png << 'EOF'
          iVBORw0KGgoAAAANSUhEUgAAAyAAAAJYCAIAAADK9nRuAAAAGXRFWHRTb2Z0
          d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB9RJREFUeNrs3cENgCAMBVD9
          P7efUl9Ii+9jZDMk1NRpWMBgAAAAAAAAAAAAAAAAAADcAyrUKFoVK1SpWFSs
          UqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWF
          SsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSp
          WFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqV
          SpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsU
          qVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFS
          sUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpWFSsUqVSpW
          FQDQ2V5KZSl+dwAAAABJRU5ErkJggg==
          EOF
          base64 -d resources/background.png > tmp && mv tmp resources/background.png

      - name: Copy DMG icon
        run: |
          mkdir -p resources/mac-icons
          cp /System/Applications/Utilities/Terminal.app/Contents/Resources/Terminal.icns resources/mac-icons/icon.icns

      - name: Create DMG with Finder customization
        run: |
          create-dmg \
            --volname "MyApp" \
            --volicon "resources/mac-icons/icon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --background "resources/background.png" \
            --icon "MyApp.app" 200 190 \
            --app-drop-link 600 185 \
            ./release/darwin/output.dmg \
            ./release/darwin/mac-arm64
